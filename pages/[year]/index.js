import Link from "next/link";
import React, { useState } from "react";
import fs from "fs";
import Layout from "../../components/Layout";
import Head from "next/head";
import path from "path";
import Years from "../../types/Years";
const LIMIT = 400;

const Year = ({ year, documents, years }) => {
  const [page, setPage] = useState(0);
  const handlePrevPage = () => setPage(page - 1);
  const handleNextPage = () => setPage(page + 1);

  return (
    <Layout years={years}>
      <Head>
        <title>{year} | Vulnerability Data</title>
      </Head>
      <div className=" breadcrumbs">
        <ul>
          <li>
            <Link href="/" passHref>
              <a>By Year</a>
            </Link>
          </li>
          <li>{year}</li>
        </ul>
      </div>
      <div className="flex justify-between items-center mb-10">
        <h2 className="py-6 text-2xl font-bold">
          Vulnerabilities reported in {year} <span className="badge border-0 relative -top-1 ml-2 bg-reconmap">{documents.length}</span>
        </h2>
        {/* <input className="input input-bordered" placeholder="Search..." onChange={handleSearch} /> */}
        <div className="flex items-center gap-2">
          {page > 1 && (
            <a className={`btn  ${page === 1 ? "btn-disabled" : ""}`} onClick={handlePrevPage}>
              ←
            </a>
          )}
          <span className="btn  pointer-events-none" onClick={handlePrevPage}>
            {page}
          </span>
          <a className="btn " onClick={handleNextPage}>
            →
          </a>
        </div>
      </div>
      <ul className="text-sm flex flex-wrap gap-1 document-links">
        {documents.slice(page * LIMIT, page * LIMIT + LIMIT).map((document) => (
          <li key={document}>
            <Link passHref href={`/${year}/CVE-${year}-${document}`}>
              <a>{document}</a>
            </Link>
          </li>
        ))}
      </ul>
    </Layout>
  );
};

export default Year;

export const getStaticProps = async (ctx) => {
  // const years = fs.readdirSync("./data").map((file) => file.match(/\d+/g));
  const dataFolder = path.join(process.cwd(), `data/${ctx.params.year}.json`);
  if (fs.existsSync(dataFolder)) {
    var json = fs.readFileSync(dataFolder, "utf8");
    return {
      props: {
        years: Years,
        year: ctx.params.year,
        documents: JSON.parse(json)
          .cvrfdoc.Vulnerability.filter((doc) => {
            if (Array.isArray(doc.Notes.Note)) {
              return !(doc.Notes.Note[0]._text.includes("** REJECT **") || doc.Notes.Note[0]._text.includes("** RESERVED **"));
            } else {
              return !(doc.Notes.Note._text.includes("** REJECT **") || doc.Notes.Note._text.includes("** RESERVED **"));
            }
          })
          .map((doc) => doc.Title._text.split("-")[2]),
      },
    };
  }
  return {
    years: Years,
    year: ctx.params.year,
    documents: null,
  };
};

export const getStaticPaths = async (ctx) => {
  return {
    paths: Years.map((year) => ({
      params: {
        year: year,
      },
    })),
    fallback: false,
  };
};
