import fs from "fs";
import path from "path";

export default async function handler(req, res) {
  if (req.method === "GET") {
    const dataFolder = path.join(process.cwd(), `data/${req.query.year}.json`);
    const json = fs.readFileSync(dataFolder, "utf8");
    const documents = JSON.parse(json)
      .cvrfdoc.Vulnerability.filter((doc) => {
        if (Array.isArray(doc.Notes.Note)) {
          return !(doc.Notes.Note[0]._text.includes("** REJECT **") || doc.Notes.Note[0]._text.includes("** RESERVED **"));
        } else {
          return !(doc.Notes.Note._text.includes("** REJECT **") || doc.Notes.Note._text.includes("** RESERVED **"));
        }
      })
      .map((doc) => doc.Title._text.split("-")[2]);

    return res.status(200).json({
      year: req.query.year,
      count: documents.length,
      documents,
    });
  }
  return res.status(403).json({ message: "Not Allowed" });
}
